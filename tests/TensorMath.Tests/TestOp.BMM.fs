// Copyright (c) 2016-     University of Oxford (Atilim Gunes Baydin <gunes@robots.ox.ac.uk>)
// and other contributors, see LICENSE in root of repository.
//
// BSD 2-Clause License. See LICENSE in root of repository.

namespace Tests

open NUnit.Framework
open TensorMath


[<TestFixture>]
type TestTensorBMM () =
    [<Test>]
    member _.TestTensorBMM () =
        for combo in Combos.FloatingPointExcept16s do
            let t1 = combo.tensor([[[-1.0372e+00,  7.5673e-01,  1.9448e+00,  3.6433e+00, -3.9134e-01],
                                     [-1.7011e+00,  3.0675e+00,  1.8387e+00, -2.3037e-01,  5.0916e-01],
                                     [ 2.1869e+00,  1.5561e+00,  1.2905e+00, -3.5149e-03, -2.0392e+00],
                                     [-1.0669e+00,  3.0033e-01,  1.2472e+00,  7.8584e-01, -5.0704e-01]],

                                    [[-2.8406e-02, -7.2715e-01, -2.6762e-02, -7.6213e-02,  1.3507e+00],
                                     [-1.0652e+00, -8.9129e-01,  1.3157e+00,  1.5385e+00, -7.5446e-02],
                                     [ 1.0338e-01,  9.9040e-02,  8.3478e-01,  2.1243e+00,  1.4483e+00],
                                     [-3.1956e-01,  1.1361e+00,  8.4474e-01, -1.2423e+00, -1.7816e+00]],

                                    [[-4.4167e-01,  4.1456e-01,  9.4991e-01, -1.3340e+00, -2.4315e+00],
                                     [-1.8150e+00,  1.1680e+00, -9.0262e-01, -4.3182e-01,  3.6071e-01],
                                     [-1.3226e-02,  1.0893e+00,  7.8359e-01,  3.6028e-01,  2.2133e-01],
                                     [-1.5645e+00,  2.5328e+00,  1.6512e+00,  1.5900e-01, -1.4043e+00]]])
            let t2 = combo.tensor([[[ 0.3481,  0.9439],
                                     [-0.5359, -1.7125],
                                     [ 1.4898,  0.6685],
                                     [-1.0406,  0.7051],
                                     [-0.2785,  0.6121]],

                                    [[ 0.4999,  0.5361],
                                     [ 3.0867, -0.8065],
                                     [-0.9747, -1.7684],
                                     [-1.5903, -0.6835],
                                     [-0.3202, -2.0839]],

                                    [[ 0.9485,  0.0655],
                                     [-0.5164,  0.4726],
                                     [-0.7083,  0.5276],
                                     [ 0.2138, -0.9645],
                                     [ 0.1784,  0.3654]]])

            let t3 = t1.bmm(t2)
            let t3Correct = combo.tensor([[[-1.5514,  1.3546],
                                             [ 0.6013, -5.4802],
                                             [ 2.4214, -0.9885],
                                             [ 0.6491, -0.4439]],

                                            [[-2.5438, -2.1440],
                                             [-6.9885, -3.0734],
                                             [-4.2981, -5.9709],
                                             [ 5.0698,  1.9803]],

                                            [[-2.0247,  1.0662],
                                             [-1.7133,  0.5051],
                                             [-1.0136,  0.6607],
                                             [-4.1779,  1.2990]]])

            Assert.That(t3Correct.allclose(t3, 0.1))

